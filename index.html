<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">
    <title>MinePixel</title>
    <script>
        // Принудительное отключение кэша
        function clearCache() {
            if ('caches' in window) {
                caches.keys().then(names => names.forEach(name => caches.delete(name)));
            }
            localStorage.clear();
            sessionStorage.clear();
        }
        
        window.addEventListener('load', clearCache);
        
        // Предотвращение кэширования
        window.applicationCache && window.applicationCache.abort();
        
        // Принудительное обновление страницы при смене версии
        const currentVersion = localStorage.getItem('gameVersion');
        const newVersion = '0.1.13';
        if (currentVersion !== newVersion) {
            localStorage.setItem('gameVersion', newVersion);
            if (currentVersion) location.reload(true);
        }
    </script>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <link rel="manifest" href="manifest.webmanifest">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@2.0.9/dist/tonconnect-ui.min.js"></script>
    <script src="https://unpkg.com/tonweb@0.0.66/dist/tonweb.js"></script>
    <script>
        // Отключаем ServiceWorker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                }
            });
        }
    </script>
</head>
<body>
    <div id="unity-container">
        <canvas id="unity-canvas"></canvas>
        <div id="unity-loading-bar">
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
        </div>
        <div id="debug-status"></div>
    </div>

    <script>
        let unityInstance = null;
        let isUnityStarted = false;
        let loadingTimeout = null;

        function updateStatus(status) {
            const statusElement = document.getElementById('debug-status');
            if (!statusElement) return;
            const version = '0.1.13';
            statusElement.textContent = `Статус: ${status} | v${version}`;
        }

        function initUnity() {
            if (isUnityStarted) return;
            isUnityStarted = true;

            // Очистка кэша перед загрузкой
            clearCache();

            const config = {
                dataUrl: `./Build/WebGL.data?v=${Date.now()}`,
                frameworkUrl: `./Build/WebGL.framework.js?v=${Date.now()}`,
                codeUrl: `./Build/WebGL.wasm?v=${Date.now()}`,
                streamingAssetsUrl: "StreamingAssets",
                companyName: "d4rk_ltd",
                productName: "MinePixel",
                productVersion: "0.1.13",
                showBanner: false
            };

            // Установка таймаута загрузки
            loadingTimeout = setTimeout(() => {
                if (!unityInstance) {
                    location.reload(true);
                }
            }, 30000);

            createUnityInstance(document.querySelector("#unity-canvas"), config, (progress) => {
                updateStatus(`Загрузка: ${Math.round(progress * 100)}%`);
            }).then((instance) => {
                clearTimeout(loadingTimeout);
                unityInstance = instance;
                updateStatus('Игра загружена');
            }).catch((error) => {
                clearTimeout(loadingTimeout);
                console.error(error);
                isUnityStarted = false;
                updateStatus('Ошибка загрузки');
            });
        }

        // Запуск Unity с задержкой
        window.addEventListener('load', () => setTimeout(initUnity, 1000));

        // Блокировка случайных перезагрузок
        window.addEventListener('beforeunload', (e) => {
            if (!unityInstance && isUnityStarted) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });
    </script>
    <script>
        const manifest = {
            "name": "MinePixel",
            "short_name": "MinePixel",
            "start_url": "./index.html?v=" + Date.now(),
            "display": "standalone",
            "background_color": "#000000",
            "theme_color": "#000000",
            "description": "MinePixel",
            "icons": [{
                "src": "TemplateData/icons/unity-logo-dark.png",
                "sizes": "144x144",
                "type": "image/png",
                "purpose": "any maskable"
            }]
        };
    </script>
</body>
</html>
